"""
Apache mod_python interface.
Based on PLCAPI's ModPython.py, by
   Aaron Klingaman <alk@absarokasoft.com>
   Mark Huang <mlhuang@cs.princeton.edu>

Original URL: http://svn.planet-lab.org/svn/PLCAPI/trunk/ModPython.py
"""

import sys
import traceback
import xmlrpclib
from mod_python import apache

sys.path.append("/usr/share/SMDS")

from mdapi import MDAPI
from SNDS.API.CDN import PL_CoBlitz

cdn = PL_CoBlitz()
api = MDAPI( cdn )

def handler(req):
    try:
        if req.method != "POST":
            req.content_type = "text/html"
            req.send_http_header()
            req.write("""
<html><head>
<title>SMDS API XML-RPC/SOAP Interface</title>
</head><body>
<h1>SMDS API XML-RPC/SOAP Interface</h1>
<p>Please use XML-RPC or SOAP to access the SMDS API.</p>
</body></html>
""")
            return apache.OK

        # Read request
        request = req.read(int(req.headers_in['content-length']))

        # mod_python < 3.2: The IP address portion of remote_addr is
        # incorrect (always 0.0.0.0) when IPv6 is enabled.
        # http://issues.apache.org/jira/browse/MODPYTHON-64?page=all
        (remote_ip, remote_port) = req.connection.remote_addr
        remote_addr = (req.connection.remote_ip, remote_port)

        # Handle request
        response = api.handle(remote_addr, request)

        # Shut down database connection, otherwise up to MaxClients DB
        # connections will remain open.
        api.db.close()

        # Write response
        req.content_type = "text/xml; charset=" + api.encoding
        req.send_http_header()
        req.write(response)

        return apache.OK

    except Exception, err:
        # Log error in /var/log/httpd/(ssl_)?error_log
        print >> log, err, traceback.format_exc()
        return apache.HTTP_INTERNAL_SERVER_ERROR
